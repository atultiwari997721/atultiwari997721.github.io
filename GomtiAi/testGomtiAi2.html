<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gomti AI Chatbot</title>
    <!-- Google Fonts - Inter for a clean, modern look (similar to SearchPro) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles inspired by SearchPro design */
        body {
            font-family: 'Inter', sans-serif; /* Clean, modern font */
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scroll, allow chat area to scroll */
            background: linear-gradient(135deg, #e0e7ff, #f0e0ff); /* Light purple/blue gradient background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Ensure it takes full viewport height */
        }
        #chat-container {
            display: flex;
            flex-direction: column;
            width: 90%; /* Responsive width */
            max-width: 768px; /* Max width for desktop */
            height: 90vh; /* Responsive height */
            background-color: #ffffff; /* White background for the main chat area */
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); /* Soft shadow */
            overflow: hidden; /* Hide overflow for rounded corners */
            margin: 20px auto; /* Center with margin */
        }
        @media (max-width: 639px) { /* Adjust height for smaller screens (phones) */
            #chat-container {
                width: 95%;
                height: calc(100vh - 40px); /* Adjust for smaller margin */
                margin: 20px auto;
            }
        }

        #chat-header {
            background: #ffffff; /* White background for header */
            padding: 1.5rem; /* Increased padding */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); /* Subtle shadow */
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            border-bottom: 1px solid #f0f0f0; /* Light separator */
        }
        #chat-header h1 {
            font-size: 2.5rem; /* Larger title */
            font-weight: 700; /* Bold */
            color: #4f46e5; /* Primary purple color */
            letter-spacing: -0.025em; /* Tighten letter spacing */
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center; /* Center the text horizontally */
        }
        #chat-header h1 svg {
            width: 2.5rem;
            height: 2.5rem;
            color: #6366f1; /* Slightly lighter purple for icon */
        }
        #chat-header p {
            font-size: 1rem;
            color: #6b7280; /* Gray tagline */
            font-weight: 500;
        }

        #chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem; /* Increased padding */
            display: flex;
            flex-direction: column;
            gap: 1rem; /* space-y-4 */
            background-color: #f9fafb; /* Very light background for chat area */
        }
        .message-row {
            display: flex;
            width: 100%;
        }
        .message-bubble {
            max-width: 85%; /* Slightly wider bubbles */
            padding: 1rem 1.25rem; /* More padding */
            border-radius: 1.25rem; /* More rounded */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); /* Soft shadow for bubbles */
            font-size: 0.9375rem; /* Slightly larger font */
            line-height: 1.6; /* Improved line height */
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .user-message {
            background-color: #e0e7ff; /* Light blue/purple from gradient */
            color: #374151; /* Darker text for readability */
            border-bottom-right-radius: 0.5rem; /* Rounded on one side */
            margin-left: auto; /* Align right */
        }
        .bot-message {
            background-color: #ffffff; /* White for bot messages */
            color: #374151; /* Darker text for readability */
            border-bottom-left-radius: 0.5rem; /* Rounded on one side */
            margin-right: auto; /* Align left */
        }
        .message-bubble p {
            margin-bottom: 0.5rem; /* Space between paragraphs */
        }
        .message-bubble p:last-child {
            margin-bottom: 0;
        }

        /* Styling for code blocks */
        .code-container {
            background-color: #f0f4f8; /* Light gray background for code */
            border: 1px solid #d1d5db; /* Light border */
            border-radius: 0.75rem; /* More rounded */
            padding: 1rem;
            margin-top: 0.75rem;
            margin-bottom: 0.75rem;
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            max-width: 85%; /* Match message bubble width */
            overflow-x: auto;
            color: #1f2937;
        }
        .code-container pre {
            margin: 0;
            padding: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .code-container code {
            font-family: 'Roboto Mono', monospace; /* Keep code font monospace */
            font-size: 0.875rem; /* Slightly larger code font */
            color: #1f2937;
            display: block;
        }
        .copy-button {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background-color: #4f46e5; /* Primary purple */
            color: white;
            padding: 0.35rem 0.75rem;
            border-radius: 0.5rem; /* More rounded */
            font-size: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            border: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            font-weight: 600;
        }
        .copy-button:hover {
            background-color: #4338ca;
            transform: translateY(-1px);
        }
        .copy-button:active {
            transform: translateY(1px);
        }
        .copy-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Styling for image grid */
        .image-grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); /* Larger grid items */
            gap: 12px;
            padding: 12px;
            background-color: #f0f4f8;
            border-radius: 1.25rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            max-width: 85%; /* Match message bubble width */
            margin-right: auto;
            margin-top: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .image-grid-item {
            width: 100%;
            padding-top: 100%;
            position: relative;
            cursor: pointer;
            overflow: hidden;
            border-radius: 0.75rem; /* More rounded */
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease-in-out;
        }
        .image-grid-item:hover {
            transform: scale(1.03);
        }
        .image-grid-item img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0.75rem;
        }
        .image-loading-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 0.75rem;
        }
        .image-loading-spinner {
            border: 4px solid #e0e7ff;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal for full-screen image view */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        .close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: #f1f1f1;
            font-size: 48px; /* Larger close button */
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: #a78bfa; /* Light purple on hover */
            text-decoration: none;
            cursor: pointer;
        }

        #message-input-area {
            padding: 1rem 1.5rem; /* More padding */
            background-color: #ffffff; /* White background */
            border-top: 1px solid #e5e7eb; /* Light border */
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.05); /* Soft shadow */
            display: flex;
            align-items: center;
            gap: 0.75rem; /* Space between elements */
        }
        #message-input {
            flex: 1;
            padding: 0.875rem 1.25rem; /* More padding */
            border: 1px solid #d1d5db; /* Light border */
            border-radius: 2rem; /* Pill shape */
            outline: none;
            resize: none;
            max-height: 7rem; /* Slightly taller max height */
            overflow-y: auto;
            background-color: #f9fafb; /* Very light background */
            color: #374151; /* Dark text */
            font-size: 1rem;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        #message-input::placeholder {
            color: #9ca3af; /* Standard placeholder text */
        }
        #message-input:focus {
            border-color: #6366f1; /* Purple on focus */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); /* Soft focus ring */
        }

        #send-button {
            padding: 0.875rem 1.5rem; /* Consistent padding */
            background: linear-gradient(45deg, #6366f1, #9333ea); /* Purple gradient */
            color: white;
            border-radius: 2rem; /* Pill shape */
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); /* Stronger shadow */
            transition: all 0.2s ease-in-out;
            font-weight: 600;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        #send-button:hover {
            background: linear-gradient(45deg, #4f46e5, #7e22ce); /* Darker gradient on hover */
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(99, 102, 241, 0.5);
        }
        #send-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }
        #send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: #a78bfa; /* Lighter purple when disabled */
            box-shadow: none;
        }
        #send-button svg {
            width: 1.25rem; /* Smaller icon */
            height: 1.25rem;
        }

        .loading-dots {
            display: flex;
            align-items: center;
        }
        .loading-dot {
            width: 0.6rem;
            height: 0.6rem;
            background-color: #6366f1; /* Purple dots for loading */
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
            margin-right: 0.2rem;
            box-shadow: 0 0 5px rgba(99, 102, 241, 0.5);
        }
        .loading-dot:nth-child(2) {
            animation-delay: 0.15s;
        }
        .loading-dot:nth-child(3) {
            animation-delay: 0.3s;
            margin-right: 0;
        }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        .initial-message {
            text-align: center;
            color: #6b7280;
            margin-top: 5rem;
            font-size: 1.125rem;
            text-shadow: none;
        }

        /* Speak button styling */
        .speak-button {
            background-color: #a78bfa; /* Light purple */
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 0.5rem;
            font-size: 0.7rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            border: none;
            margin-top: 0.6rem; /* Space from message text */
            align-self: flex-end;
            font-weight: 500;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .speak-button:hover {
            background-color: #8b5cf6;
        }
        .speak-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #d1d5db;
        }
        .speak-button.active {
            background-color: #22c55e; /* Green when speaking */
        }

        /* Mic button styling */
        #mic-button {
            padding: 0.875rem; /* Square button, consistent with send button height */
            background-color: #a78bfa; /* Light purple for mic */
            color: white;
            border-radius: 2rem; /* Pill shape */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease-in-out, transform 0.1s ease-in-out;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        #mic-button:hover {
            background-color: #8b5cf6;
            transform: translateY(-1px);
        }
        #mic-button:active {
            transform: translateY(1px);
        }
        #mic-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #d1d5db;
        }
        #mic-button svg {
            width: 1.25rem; /* Consistent icon size with send button */
            height: 1.25rem;
        }
        /* Animation for pulsing mic icon */
        .animate-pulse {
            animation: pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
    </style>
</head>
<body>
    <div id="chat-container">
        <!-- Chat header -->
        <header id="chat-header">
            <h1 class="text-3xl font-bold">
                Gomti AI
            </h1>
            <p>Discover the web with our intelligent chatbot</p>
        </header>

        <!-- Chat messages display area -->
        <div id="chat-messages">
            <div id="initial-message" class="initial-message">
                <p>Start a conversation with GOMTI</p>
            </div>
        </div>

        <!-- Message input and send button -->
        <div id="message-input-area">
            <textarea
                id="message-input"
                placeholder="Search the web..."
                rows="1"
            ></textarea>
            <button id="mic-button" title="Click to speak.">
                <!-- Microphone Icon (Heroicons) -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                    <path d="M8.25 4.5a3.75 3.75 0 1 1 7.5 0v8.25a3.75 3.75 0 1 1-7.5 0V4.5Z" />
                    <path d="M6 10.5a.75.75 0 0 1 .75.75v1.5a5.25 5.25 0 1 0 10.5 0v-1.5a.75.75 0 0 1 1.5 0v1.5a6.75 6.75 0 1 1-13.5 0v-1.5a.75.75 0 0 1 .75-.75Z" />
                </svg>
            </button>
            <button id="send-button">
                Search
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                    <path fill-rule="evenodd" d="M10.5 3.75a6.75 6.75 0 1 0 0 13.5 6.75 6.75 0 0 0 0-13.5ZM2.25 10.5a8.25 8.25 0 1 1 14.59 5.28l4.694 4.693a.75.75 0 1 1-1.06 1.06l-4.693-4.694A8.25 8.25 0 0 1 2.25 10.5Z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>
    </div>

    <!-- The Modal for full-screen image view -->
    <div id="imageModal" class="modal">
        <span class="close">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>

    <script>
        // Get references to DOM elements
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        let initialMessageDiv = document.getElementById('initial-message');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const closeModal = document.getElementsByClassName('close')[0];
        const micButton = document.getElementById('mic-button');

        // Array to store chat messages for context
        const messages = [];
        let isLoading = false; // Flag to indicate if a response is being processed
        let currentUtterance = null; // To keep track of the currently speaking utterance

        // --- Speech Synthesis Voice Handling ---
        let allVoices = []; // Global variable to store voices
        let voicesLoaded = false; // Flag to track if voices have been loaded

        function populateVoiceList() {
            allVoices = speechSynthesis.getVoices();
            if (allVoices.length > 0) {
                voicesLoaded = true;
                console.log('Speech synthesis voices loaded:', allVoices.map(v => v.name));
            } else {
                voicesLoaded = false;
                console.warn('No speech synthesis voices found. Speak functionality may not work.');
            }
            // Update existing speak buttons
            document.querySelectorAll('.speak-button').forEach(btn => {
                btn.disabled = !voicesLoaded;
            });
        }

        function getVoiceByLanguage(langCode) {
            // Try to find an exact match first
            let voice = allVoices.find(v => v.lang === langCode);
            if (voice) return voice;

            // If not found, try to find a voice that starts with the language code
            voice = allVoices.find(v => v.lang.startsWith(langCode));
            if (voice) return voice;

            // Fallback to a generic English voice if nothing specific is found
            return allVoices.find(v => v.lang.startsWith('en')) || null;
        }

        function isHindi(text) {
            // Basic check for Devanagari Unicode range (U+0900 to U+097F)
            // This is a very simple heuristic and might not be accurate for all cases.
            return /[\u0900-\u097F]/.test(text);
        }

        // Check if voices are already available or wait for them to load
        if (speechSynthesis.getVoices().length > 0) {
            populateVoiceList();
        } else {
            speechSynthesis.onvoiceschanged = populateVoiceList;
        }
        // --- End Speech Synthesis Voice Handling ---

        // --- Web Speech API (SpeechRecognition) Handling ---
        let recognition = null; // SpeechRecognition object

        if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.interimResults = true; // Get interim results
            recognition.lang = 'en-US'; // Set language

            let finalTranscript = ''; // To store the final recognized text

            recognition.onstart = () => {
                micButton.style.backgroundColor = '#FFC107'; // Yellow when listening
                micButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 animate-pulse"><path d="M8.25 4.5a3.75 3.75 0 1 1 7.5 0v8.25a3.75 3.75 0 1 1-7.5 0V4.5Z" /><path d="M6 10.5a.75.75 0 0 1 .75.75v1.5a5.25 5.25 0 1 0 10.5 0v-1.5a.75.75 0 0 1 1.5 0v1.5a6.75 6.75 0 1 1-13.5 0v-1.5a.75.75 0 0 1 .75-.75Z" /></svg>'; // Pulsing mic icon
                micButton.title = 'Listening... Click to stop.';
                sendButton.disabled = true; // Disable send button while recording
                messageInput.disabled = true; // Disable typing while recording
                finalTranscript = ''; // Reset transcript
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                // Update textarea with combined final and interim results
                messageInput.value = finalTranscript + interimTranscript;
                messageInput.style.height = 'auto'; // Adjust height
                messageInput.style.height = messageInput.scrollHeight + 'px';
            };

            recognition.onend = () => {
                micButton.style.backgroundColor = '#a78bfa'; // Light purple when stopped
                micButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M8.25 4.5a3.75 3.75 0 1 1 7.5 0v8.25a3.75 3.75 0 1 1-7.5 0V4.5Z" /><path d="M6 10.5a.75.75 0 0 1 .75.75v1.5a5.25 5.25 0 1 0 10.5 0v-1.5a.75.75 0 0 1 1.5 0v1.5a6.75 6.75 0 1 1-13.5 0v-1.5a.75.75 0 0 1 .75-.75Z" /></svg>';
                micButton.title = 'Click to speak.';
                messageInput.disabled = false; // Enable typing
                // If there's content, ensure the send button is enabled
                if (messageInput.value.trim() !== '') {
                     sendButton.disabled = false;
                } else {
                     sendButton.disabled = true; // Disable if empty
                }
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                micButton.style.backgroundColor = '#EF4444'; // Red on error
                micButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path fill-rule="evenodd" d="M9.401 3.003c1.155-2 4.043-2 5.197 0l7.153 12.497c1.155 2-.29 4.5-2.599 4.5H4.847c-2.309 0-3.754-2.5-2.599-4.5L9.401 3.003ZM12 8.25a.75.75 0 0 1 .75.75v3.75a.75.75 0 0 1-1.5 0V9a.75.75 0 0 1 .75-.75Zm0 12a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z" clip-rule="evenodd" /></svg>'; // Error icon
                let errorMessage = 'Error. Click to retry.';
                if (event.error === 'not-allowed') {
                    errorMessage = 'Microphone access denied. Please allow microphone in browser settings. If running locally, ensure you are using HTTPS.';
                } else if (event.error === 'no-speech') {
                    errorMessage = 'No speech detected. Please try again.';
                } else if (event.error === 'network') {
                    errorMessage = 'Network error. Check your internet connection.';
                }
                micButton.title = errorMessage;
                messageInput.disabled = false;
                if (messageInput.value.trim() !== '') {
                     sendButton.disabled = false;
                } else {
                     sendButton.disabled = true;
                }
            };

            micButton.addEventListener('click', () => {
                if (recognition.recognizing) {
                    recognition.stop();
                } else {
                    recognition.start();
                }
            });

        } else {
            micButton.disabled = true;
            micButton.title = 'Speech Recognition not supported in this browser.';
            console.warn('Web Speech API (SpeechRecognition) not supported in this browser.');
            micButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25Zm-1.72 6.97a.75.75 0 1 0-1.06 1.06L10.94 12l-1.72 1.72a.75.75 0 1 0 1.06 1.06L12 13.06l1.72 1.72a.75.75 0 1 0 1.06-1.06L13.06 12l1.72-1.72a.75.75 0 1 0-1.06-1.06L12 10.94l-1.72-1.72Z" clip-rule="evenodd" /></svg>'; // X-circle icon
        }
        // --- End Web Speech API (SpeechRecognition) Handling ---


        // Function to process text for readability (newlines and paragraphs)
        function formatTextForDisplay(text) {
            // Replace triple or more newlines with double newlines for consistent paragraph separation
            text = text.replace(/\n{3,}/g, '\n\n');
            // Split by double newlines to identify paragraphs
            const paragraphs = text.split('\n\n');
            let formattedHtml = '';
            paragraphs.forEach(p => {
                if (p.trim() !== '') {
                    // Replace single newlines within a paragraph with <br>
                    const lines = p.split('\n');
                    formattedHtml += `<p>${lines.join('<br>')}</p>`;
                }
            });
            return formattedHtml;
        }

        // Function to create and append a message bubble to the chat
        function appendMessage(content, sender, type = 'text') {
            // Remove the initial message if it exists
            if (initialMessageDiv) {
                initialMessageDiv.remove();
                initialMessageDiv = null;
            }

            const messageRow = document.createElement('div');
            messageRow.classList.add('message-row', 'flex');
            if (sender === 'user') {
                messageRow.classList.add('justify-end'); // Tailwind: justify-end
            } else {
                messageRow.classList.add('justify-start'); // Tailwind: justify-start
            }

            if (type === 'text') {
                // Regex to detect a Markdown fenced code block
                const codeBlockRegex = /^\s*```(\w+)?\n([\s\S]*?)\n\s*```\s*$/;
                const match = content.match(codeBlockRegex);

                if (sender === 'bot' && match) {
                    // If it's a bot message and contains a code block
                    const codeContent = match[2].trim(); // Extract the code content
                    const language = match[1] || 'plaintext'; // Extract language or default to plaintext

                    const codeContainer = document.createElement('div');
                    codeContainer.classList.add('code-container');
                    codeContainer.classList.add('bot-message'); // Apply bot message styling for consistency

                    const preElement = document.createElement('pre');
                    const codeElement = document.createElement('code');
                    codeElement.textContent = codeContent;
                    codeElement.classList.add(`language-${language}`); // Add language class for potential syntax highlighting

                    preElement.appendChild(codeElement);
                    codeContainer.appendChild(preElement);

                    const copyButton = document.createElement('button');
                    copyButton.textContent = 'Copy Code';
                    copyButton.classList.add('copy-button');
                    copyButton.onclick = () => {
                        // Use document.execCommand('copy') for better compatibility in iframes
                        const textarea = document.createElement('textarea');
                        textarea.value = codeContent;
                        document.body.appendChild(textarea);
                        textarea.select();
                        try {
                            document.execCommand('copy');
                            copyButton.textContent = 'Copied!';
                            setTimeout(() => {
                                copyButton.textContent = 'Copy Code';
                            }, 2000);
                        } catch (err) {
                            console.error('Failed to copy text: ', err);
                            copyButton.textContent = 'Failed!';
                        }
                        document.body.removeChild(textarea);
                    };
                    codeContainer.appendChild(copyButton);

                    messageRow.appendChild(codeContainer);

                } else {
                    // For regular text messages (both user and bot)
                    const messageBubble = document.createElement('div');
                    messageBubble.classList.add(
                        'message-bubble',
                        'p-3',
                        'rounded-xl',
                        'shadow-md',
                        'max-w-xs',
                        'sm:max-w-md',
                        'lg:max-w-lg'
                    ); // Common styles
                    if (sender === 'user') {
                        messageBubble.classList.add('user-message'); // User specific styles
                    } else {
                        messageBubble.classList.add('bot-message'); // Bot specific styles
                    }

                    const messageText = document.createElement('div');
                    messageText.classList.add('text-sm', 'sm:text-base'); // Tailwind: text-sm sm:text-base
                    messageText.innerHTML = formatTextForDisplay(content); // Use innerHTML with formatted text
                    messageBubble.appendChild(messageText);

                    if (sender === 'bot') {
                        // Add Speak Button only for bot messages
                        const speakButton = document.createElement('button');
                        speakButton.textContent = 'Speak';
                        speakButton.classList.add('speak-button');
                        // Set initial disabled state based on voicesLoaded
                        speakButton.disabled = !voicesLoaded;
                        speakButton.onclick = () => {
                            if (speechSynthesis.speaking && currentUtterance && currentUtterance.text === content) {
                                // If currently speaking this message, stop it
                                speechSynthesis.cancel();
                                speakButton.textContent = 'Speak';
                                speakButton.classList.remove('active'); // Remove active class
                                currentUtterance = null;
                            } else {
                                // If another message is speaking, stop it first
                                if (speechSynthesis.speaking) {
                                    speechSynthesis.cancel();
                                    // Find and reset the previous speak button if it exists
                                    document.querySelectorAll('.speak-button').forEach(btn => {
                                        if (btn !== speakButton) {
                                            btn.textContent = 'Speak';
                                            btn.classList.remove('active'); // Remove active class from other buttons
                                        }
                                    });
                                }

                                // Start speaking the current message
                                const utterance = new SpeechSynthesisUtterance(content);

                                // Determine language and select voice
                                let targetLang = 'en-US'; // Default to English
                                if (isHindi(content)) {
                                    targetLang = 'hi-IN'; // If content seems Hindi, target Hindi
                                }
                                const selectedVoice = getVoiceByLanguage(targetLang);
                                if (selectedVoice) {
                                    utterance.voice = selectedVoice;
                                    utterance.lang = selectedVoice.lang; // Set utterance lang to match voice
                                } else {
                                    console.warn(`No suitable voice found for ${targetLang}. Using default.`);
                                }

                                utterance.onend = () => {
                                    speakButton.textContent = 'Speak';
                                    speakButton.classList.remove('active'); // Remove active class on end
                                    currentUtterance = null;
                                };
                                utterance.onerror = (event) => {
                                    console.error('SpeechSynthesisUtterance.onerror', event);
                                    speakButton.textContent = 'Speak';
                                    speakButton.classList.remove('active'); // Remove active class on error
                                    currentUtterance = null;
                                };
                                speechSynthesis.speak(utterance);
                                speakButton.textContent = 'Stop';
                                speakButton.classList.add('active'); // Add active class
                                currentUtterance = utterance;
                            }
                        };
                        messageBubble.appendChild(speakButton);
                    }
                    messageRow.appendChild(messageBubble);
                }
            } else if (type === 'image_grid') {
                const imageGridContainer = document.createElement('div');
                imageGridContainer.classList.add('image-grid-container');
                imageGridContainer.classList.add('bot-message'); // Apply bot message styling for consistency

                content.forEach(imageUrl => {
                    const gridItem = document.createElement('div');
                    gridItem.classList.add('image-grid-item');

                    const img = document.createElement('img');
                    img.src = imageUrl;
                    img.alt = 'Generated Image';
                    img.onerror = () => {
                        img.src = `https://placehold.co/100x100/FF0000/FFFFFF?text=Error`; // Placeholder for failed images
                        img.alt = 'Image Load Error';
                    };
                    img.onclick = () => {
                        modalImage.src = imageUrl;
                        imageModal.style.display = 'flex'; // Show modal
                    };

                    gridItem.appendChild(img);
                    imageGridContainer.appendChild(gridItem);
                });
                messageRow.appendChild(imageGridContainer);
            }
            chatMessages.appendChild(messageRow);

            // Scroll to the latest message
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Function to display a loading indicator
        function showLoadingIndicator(indicatorType = 'dots') {
            // Remove the initial message if it exists
            if (initialMessageDiv) {
                initialMessageDiv.remove();
                initialMessageDiv = null;
            }

            const loadingRow = document.createElement('div');
            loadingRow.id = 'loading-indicator';
            loadingRow.classList.add('flex', 'justify-start');

            const loadingBubble = document.createElement('div');
            loadingBubble.classList.add(
                'message-bubble',
                'p-3',
                'rounded-xl',
                'shadow-md',
                'rounded-bl-none',
                'bot-message'
            );

            if (indicatorType === 'dots') {
                const loadingDots = document.createElement('div');
                loadingDots.classList.add('loading-dots', 'flex', 'items-center');
                for (let i = 0; i < 3; i++) {
                    const dot = document.createElement('div');
                    dot.classList.add('loading-dot');
                    if (i === 1) dot.classList.add('delay-150');
                    if (i === 2) dot.classList.add('delay-300');
                    loadingDots.appendChild(dot);
                }
                loadingBubble.appendChild(loadingDots);
            } else if (indicatorType === 'spinner') {
                const spinnerContainer = document.createElement('div');
                spinnerContainer.classList.add('image-loading-indicator');
                const spinner = document.createElement('div');
                spinner.classList.add('image-loading-spinner');
                spinnerContainer.appendChild(spinner);
                loadingBubble.appendChild(spinnerContainer);
            }

            loadingRow.appendChild(loadingBubble);
            chatMessages.appendChild(loadingRow);

            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Function to remove the loading indicator
        function hideLoadingIndicator() {
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) {
                loadingIndicator.remove();
            }
        }

        // Close the modal when the close button is clicked
        closeModal.onclick = function() {
            imageModal.style.display = 'none';
            modalImage.src = ''; // Clear image source
        }

        // Close the modal when clicking outside the image
        imageModal.onclick = function(event) {
            if (event.target === imageModal) {
                imageModal.style.display = 'none';
                modalImage.src = ''; // Clear image source
            }
        }

        // Function to handle sending a message
        async function handleSendMessage() {
            const input = messageInput.value.trim();
            if (input === '' || isLoading) return; // Don't send empty messages or if loading

            // Stop any ongoing speech when a new message is sent
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
                document.querySelectorAll('.speak-button').forEach(btn => {
                    btn.textContent = 'Speak';
                    btn.classList.remove('active'); // Ensure all buttons reset
                });
                currentUtterance = null;
            }

            appendMessage(input, 'user'); // Add user message to chat display
            messages.push({ role: 'user', parts: [{ text: input }] }); // Add to chat history
            messageInput.value = ''; // Clear the input field
            messageInput.style.height = 'auto'; // Reset textarea height

            isLoading = true; // Set loading state
            sendButton.disabled = true; // Disable send button
            micButton.disabled = true; // Disable mic button while processing

            try {
                let botResponseText = '';
                const lowerCaseInput = input.toLowerCase();

                // Define subject keywords
                const subjectKeywords = [
                    "math", "mathematics", "algebra", "geometry", "calculus", "equation", "formula", "solve", "calculate", "theorem",
                    "physics", "force", "energy", "motion", "gravity", "light", "sound", "electricity", "mechanics", "thermodynamics", "quantum",
                    "chemistry", "chemical", "molecule", "atom", "reaction", "element", "compound", "bond", "periodic table", "acid", "base",
                    "biology", "organism", "cell", "dna", "gene", "ecosystem", "anatomy", "physiology", "botany", "zoology",
                    "subject", "question about", "explain", "define", "what is", "how does", "theory", "concept"
                ];

                let isSubjectQuery = false;
                if (subjectKeywords.some(keyword => lowerCaseInput.includes(keyword))) {
                    isSubjectQuery = true;
                }

                // Check for Hindi keywords related to who made the bot
                if (lowerCaseInput.includes('tumhe kisne banaya hai') ||
                    lowerCaseInput.includes('appko kisne banaya hai')) {
                    botResponseText = "अतुल तिवारी ने";
                    messages.push({ role: 'model', parts: [{ text: botResponseText }] }); // Add to chat history
                    appendMessage(botResponseText, 'bot'); // Add bot's response to chat display
                    hideLoadingIndicator();
                }
                // Check for English keywords related to who made the bot
                else if (lowerCaseInput.includes('who made you') ||
                    lowerCaseInput.includes('who created you') ||
                    lowerCaseInput.includes('who is your owner') ||
                    lowerCaseInput.includes('your creator') ||
                    lowerCaseInput.includes('your owner') ||
                    lowerCaseInput.includes('who is your developer')) {
                    botResponseText = "Atul Tiwari Made me or Atul Tiwari is my owner";
                    messages.push({ role: 'model', parts: [{ text: botResponseText }] }); // Add to chat history
                    appendMessage(botResponseText, 'bot'); // Add bot's response to chat display
                    hideLoadingIndicator();
                }
                // New condition for "Who is Gomti"
                else if (lowerCaseInput.includes('who is gomti')) {
                    botResponseText = "Gomti Is Ai Made By Atul Tiwari";
                    messages.push({ role: 'model', parts: [{ text: botResponseText }] });
                    appendMessage(botResponseText, 'bot');
                    hideLoadingIndicator();
                }
                // Check for image generation request
                else if (lowerCaseInput.includes('generate image of') ||
                           lowerCaseInput.includes('show me a picture of') ||
                           lowerCaseInput.includes('create an image of') ||
                           lowerCaseInput.includes('draw me a') ||
                           lowerCaseInput.includes('image of') ||
                           lowerCaseInput.includes('picture of')) {

                    showLoadingIndicator('spinner'); // Show spinner for image generation

                    const imagePrompt = input.replace(/^(generate image of|show me a picture of|create an image of|draw me a|image of|picture of)\s*/i, '').trim();

                    const payload = { instances: { prompt: imagePrompt }, parameters: { "sampleCount": 1} };
                    const apiKey = ""; // Canvas will provide this at runtime for imagen-3.0-generate-002
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                        const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                        appendMessage([imageUrl], 'bot', 'image_grid'); // Display image in grid
                        messages.push({ role: 'model', parts: [{ text: `Generated image for: "${imagePrompt}"` }] }); // Log image generation in history
                    } else {
                        botResponseText = 'Sorry, I could not generate an image for that request.';
                        appendMessage(botResponseText, 'bot');
                        messages.push({ role: 'model', parts: [{ text: botResponseText }] });
                    }
                    hideLoadingIndicator();

                } else {
                    // Regular text response from Gemini API
                    showLoadingIndicator('dots'); // Show dots for text generation

                    // Determine if it's a code request
                    const programmingKeywords = ['code', 'function', 'syntax', 'example', 'how to write', 'script', 'program', 'language', 'implement', 'class', 'method', 'loop', 'variable', 'algorithm', 'json', 'html', 'css', 'javascript', 'python', 'java', 'c++', 'php', 'ruby', 'swift', 'kotlin', 'sql'];
                    const isCodeRequest = programmingKeywords.some(keyword => lowerCaseInput.includes(keyword));

                    let promptForApi = input;
                    if (isCodeRequest) {
                        promptForApi += "\nPlease provide the response as a markdown fenced code block, specifying the language (e.g., ```javascript\\n...code...\\n```).";
                    }

                    // Prepare chat history for the API call, including the potentially modified last prompt
                    const chatHistoryForApi = messages.map(msg => ({
                        role: msg.role,
                        parts: msg.parts
                    }));
                    chatHistoryForApi.push({ role: 'user', parts: [{ text: promptForApi }] });

                    const payload = {
                        contents: chatHistoryForApi, // Send the full chat history for context
                    };

                    const apiKey = "AIzaSyAd5ONR1vb-n-fzCKqUk1nPn42rHB-XeRA";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('API Error:', errorData);
                        throw new Error(`API request failed with status ${response.status}: ${errorData.error.message || 'Unknown error'}`);
                    }

                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        botResponseText = result.candidates[0].content.parts[0].text;
                    } else {
                        botResponseText = 'Sorry, I could not get a response.';
                    }

                    // Check if the response is already a fenced code block
                    const codeBlockRegexCheck = /^\s*```(\w+)?\n([\s\S]*?)\n\s*```\s*$/;
                    const isAlreadyFencedCode = codeBlockRegexCheck.test(botResponseText);

                    // If it's a subject query and not already a fenced code block, format it as one
                    if (isSubjectQuery && !isAlreadyFencedCode) {
                        botResponseText = '```plaintext\n' + botResponseText + '\n```';
                    }

                    messages.push({ role: 'model', parts: [{ text: botResponseText }] }); // Add to chat history
                    appendMessage(botResponseText, 'bot'); // Add bot's response to chat display
                    hideLoadingIndicator();
                }

            } catch (error) {
                console.error('Error communicating with API:', error);
                const errorMessage = `Error: ${error.message}. Please try again.`;
                appendMessage(errorMessage, 'bot');
                messages.push({ role: 'model', parts: [{ text: errorMessage }] });
                hideLoadingIndicator();
            } finally {
                isLoading = false; // Reset loading state
                sendButton.disabled = false; // Enable send button
                micButton.disabled = false; // Enable mic button
                // Re-check mic button disabled state based on voicesLoaded
                micButton.disabled = !voicesLoaded;
            }
        }

        // Event listener for send button click
        sendButton.addEventListener('click', handleSendMessage);

        // Event listener for Enter key press in the input field
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { // Allow Shift+Enter for new line
                e.preventDefault(); // Prevent default new line behavior
                handleSendMessage();
            }
        });

        // Adjust textarea height dynamically based on content
        messageInput.addEventListener('input', () => {
            messageInput.style.height = 'auto'; // Reset height to recalculate
            messageInput.style.height = messageInput.scrollHeight + 'px'; // Set height to scrollHeight
            // Enable/disable send button based on input content
            sendButton.disabled = messageInput.value.trim() === '';
        });

        // Initial setup on window load
        window.onload = function() {
            // Ensure the initial message is displayed correctly
            initialMessageDiv = document.getElementById('initial-message');
            if (messages.length === 0 && !initialMessageDiv) {
                 const initialMsg = document.createElement('div');
                 initialMsg.id = 'initial-message';
                 initialMsg.classList.add('initial-message');
                 initialMsg.innerHTML = '<p>Start a conversation with GOMTI</p>';
                 chatMessages.appendChild(initialMsg);
                 initialMessageDiv = initialMsg; // Re-assign the reference
            }
            // Initial state for send button
            sendButton.disabled = true;
            // Initial state for mic button
            micButton.disabled = !voicesLoaded;
        };
    </script>
</body>
</html>
